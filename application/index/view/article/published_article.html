{extend name="layout/layout" /}

{block name="cssOrcrsipt"}
<link rel="stylesheet" href="/static/web/css1/published_article.css">
<link href="http://172.16.100.118/static/plugin/kindeditor/themes/default/default.css" rel="stylesheet">
{/block}

{block name="main"}

<div style="min-height: 300px;width: 100%;">
    <div class="web-content">
        <div class="web-content-left">
            {include file="layout:navigation" /}
        </div>

        <div class="web-content-right">
            <div style="width: 100%;min-height: 100px;background: #0FD6DD"></div>
            <div style="min-height: 500px;width: 100%;background: white;">
                <div class="web-content-right-title">发表文章</div>
                <input type="hidden" id="fr-id" value="{$articleInfo?$articleInfo['id']:0}">
                <input type="hidden" id="fr-draft" value="{$articleInfo && $articleInfo['status'] == 2 ?1:0}">
                <div class="web-fabiao">
                    <ul>
                        <li>标题</li>
                        <li><input type="text" value="{$articleInfo?$articleInfo['title']:''}" id="fr-title" placeholder="请输入文章标题"></li>
                    </ul>
                </div>
                <div class="web-fabiao">
                    <ul>
                        <li>摘要</li>
                        <li><input type="text"  value="{$articleInfo?$articleInfo['excerpt']:''}" id="fr-zaiyao" placeholder="请输入文章摘要"></li>
                    </ul>
                </div>
                <div class="web-fabiao">
                    <ul>
                        <li>标签</li>
                        <li><input type="text" value="{$articleInfo?$articleInfo['tag']:''}" id="fr-tag" placeholder="文章标签 例如(xxx,xxx,xxx) 请用英文逗号',' 分割,标签有利于文章之间的关联"></li>
                    </ul>
                </div>
                <div style="padding-left: 10px;">
                    <div style="width: 90%;margin-top: 35px; margin-left: 44px;">
                        <textarea id="editor_id" name="content" style="width:99% !important;height:300px;background: white;"><?php echo $articleInfo?$articleInfo['content']:''; ?></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{/block}
<script src="/static/js/functions.js" type="text/javascript" charset="utf-8"></script>
<script charset="utf-8" src="/static/plugin/kindeditor/kindeditor-all.js"></script>
<script charset="utf-8" src="/static/plugin/kindeditor/lang/zh-CN.js"></script>
{block name="script"}
<script>
    KindEditor.ready(function (K) {
        K.allowImageRemote = false;
        window.editor = K.create('#editor_id', {
            cssPath: '/static/plugin/kindeditor/plugins/code/prettify.css',
            resizeMode: 1,
            items: [
                'source', '|', 'undo', 'redo', '|', 'preview', 'print', 'template', 'code', 'cut', 'copy', 'paste',
                'plainpaste', 'wordpaste', '|', 'justifyleft', 'justifycenter', 'justifyright',
                'justifyfull', 'insertorderedlist', 'insertunorderedlist', 'indent', 'outdent', 'subscript',
                'superscript', 'clearhtml', 'quickformat', 'selectall', '|',
                'formatblock', 'fontname', 'fontsize', '|', 'forecolor', 'hilitecolor', 'bold',
                'italic', 'underline', 'strikethrough', 'lineheight', 'removeformat', '|', 'image', 'table', 'hr', 'pagebreak',
                'anchor', 'link', 'unlink'
            ],
            uploadJson: '/index/upload/editUploadImgFile',
            allowFileManager: false,
            allowImageRemote: true,
            syncType: 'auto',
            afterCreate: function () {
                var self = this;
                self.sync();
            }
        });

        window.editor.sync();
    });

    $(document).on('focus', '#remoteUrl', function () {
        $(this).prop("readonly", "readonly");
        $(this).parent().hide();
    });

    var objClass = {
        loading: false,
        loading2: false,
        getData:function(flag){
            window.editor.sync();
            var imgArr = [];
            $.each($('.cus-fr-images'), function (key, val) {
                imgArr.push(val.src);
            });

            return {
                article_id:$('#fr-id').val(),
                flag:flag,
                title: $.trim($('#fr-title').val()),
                tag: $('#fr-tag').val(),
                content: $.trim($('#editor_id').val()),
                excerpt: $('#fr-zaiyao').val(),
                thumbnail_img: imgArr,
                isdraft:$('#fr-draft').val(),
            };
        },
        submit: function (flag) {
            var data = this.getData(flag);
            if (data.title == '') {
                alert('标题不能为空');
            }else if (!this.loading) {
                $.ajax({
                    url: "/index/article/releaseArticle",
                    type: 'post',
                    data: data,
                    dataType: 'json',
                    beforeSend: function () {
                        objClass.loading = true;
                    },
                    complete: function () {
                        objClass.loading = false;
                    },
                    success: function (res) {
                        if (res.code == 200) {
                            alert('发布成功');
                            window.location.href = '/index/article/graphic';
                        } else {
                            alert(res.msg);
                        }
                    }
                });
            }
        },
    };

    $("#btn-input-file").on("change", function () {
        if (objClass.loading2) {
            return false;
        }

        var formData = new FormData($('#infoLogoForm')[0]);
        formData.append('type', 5);
        $.ajax({
            url: '/index/upload/uploadImgFile',
            type: 'POST',
            cache: false,
            data: formData,
            processData: false,
            contentType: false,
            dataType: "json",
            beforeSend: function () {
                objClass.loading2 = true;
                $(".wl-zh1").show();
            },
            complete: function () {
                objClass.loading2 = false;
                $(".wl-zh1").hide();
            },
            success: function (data) {
                if (data.code == 200) {
                    $('#ccc').append('<div  class="cus-remove-img-list"><img src="' + data.data.url + '" class="cus-fr-images" width="120" height="120" ><span class="iconfont icon-roundclosefill cus-remove-img" ></span></div>');
                    if ($('.cus-fr-images').length >= 3) {
                        $('#btn-input-file').prop('disabled', true);
                    }
                } else {
                    alert(data.msg);
                }
            }
        });
    });

</script>
{/block}