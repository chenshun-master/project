<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>商户后台管理系统</title>
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <link rel="stylesheet" href="/static/admin/bower_components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/admin/bower_components/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/static/admin/bower_components/Ionicons/css/ionicons.min.css">
    <link rel="stylesheet" href="/static/admin/dist/css/AdminLTE.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,300italic,400italic,600italic">
    <script src="/static/admin/bower_components/jquery/dist/jquery.min.js"></script>
    <link rel="stylesheet" href="/pc/layui/css/layui.css"  media="all">
    <style type="text/css">
        .breadcrumb{border-bottom: 1px solid #cfc5c5 !important; margin-bottom: 3px !important;}
    </style>
</head>
<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">
    <section class="content" >
        <div class="row">
            <div class="col-md-6">
                <div class="box box-primary">
                    <div class="box-header with-border">
                        <h3 class="box-title">添加商品规则</h3>
                    </div>
                    <form role="form" onsubmit="return false;">
                        <div class="box-body" style="height: 400px;overflow-y: auto">
                            <div class="form-group">
                                <label >规则名称</label>
                                <input type="text" class="form-control fr-blur" id="fr-name" placeholder="规则名称" >
                            </div>
                            <div class="form-group">
                                <label >规则备注</label>
                                <input type="text" class="form-control fr-blur" id="fr-remarks" placeholder="规则备注说明">
                            </div>

                            <div class="form-group">
                                <label>规则信息</label>
                                <div>
                                    <table class="layui-table">
                                        <colgroup>
                                            <col width="150"><col width="150"><col  width="100">
                                        </colgroup>
                                        <thead>
                                        <tr>
                                            <th>规则值</th>
                                            <th>提示信息(不能重复)</th>
                                            <th></th>
                                        </tr>
                                        </thead>
                                        <tbody id="test-table"></tbody>
                                        <tbody>
                                        <tr>
                                            <td colspan="3" style="text-align: right;">
                                                <button type="button" class="btn " onclick="obj.createSpecRow()">添加一行</button>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="box-footer" style="text-align: center">
                            <button class="layui-btn layui-btn-normal layui-btn-radius" onclick="obj.btn()">立即保存</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>
</div>
{js href="/pc/layui/layui.all.js" /}
<script type="text/javascript">
    var obj = {
        createSpecRow:function(){
            var html = '<tr>' +
                '<td><input type="text" class="form-control fr-blur" name="specval[]"  placeholder="规则值"></td>' +
                '<td><input type="text" class="form-control fr-blur" name="specname[]" placeholder="提示信息"></td>' +
                '<td data-id="0">' +
                '<i class="fa fa-fw fa-arrow-down cus-tr-move" style="cursor: pointer"  data-type="down" title="向下移动" ></i>' +
                '<i class="fa fa-fw fa-arrow-up cus-tr-move" style="cursor: pointer"  data-type="up" title="向上移动"></i>' +
                '<i class="fa fa-fw fa-close cus-tr-move" style="cursor: pointer" data-type="del" ></i>' +
                '</td>' +
                '</tr>';

            $('#test-table').append(html);
        },
        tdMove:function(td,oper){
            var data_tr=$(td).parent().parent(); //获取到触发的tr
            if(oper=="up"){    //向上移动
                if($(data_tr).prev().html()==null){ //获取tr的前一个相同等级的元素是否为空
                    return;
                }else {
                    $(data_tr).insertBefore($(data_tr).prev()); //将本身插入到目标tr的前面
                }
            }else{
                if($(data_tr).next().html()==null){
                    return;
                }else {
                    $(data_tr).insertAfter($(data_tr).next()); //将本身插入到目标tr的后面
                }
            }
        },
        btn:function(){
            var o = new Object();
            var verify = true;

            var data = {
                spec_name:$.trim($('#fr-name').val()),
                spec_type:1,
                spec_val:o,
                remarks:$.trim($('#fr-remarks').val()),
            };

            if(data.spec_name == ''){
                layer.msg('规则名称不能为空');
                return false;
            }else if(data.remarks == ''){
                layer.msg('备注不能为空');
                return false;
            }else if($('input[name^="specval"]').length == 0){
                layer.msg('规则信息不能为空');
                return false;
            }

            $.each($('input[name^="specval"]'),function(k,v){
                if($.trim($('input[name^="specval"]')[k].value) == ''){
                    $('input[name^="specval"]').eq(k).css('border','1px solid red');
                    verify = false;
                    return false;
                }else {
                    $('input[name^="specval"]').eq(k).css('border','none');
                    verify = true;
                }

                if($.trim($('input[name^="specname"]')[k].value) == ''){
                    $('input[name^="specname"]').eq(k).css('border','1px solid red');
                    verify = false;
                    return false;
                }else{
                    $('input[name^="specname"]').eq(k).css('border','none');
                    verify = true;
                }

                o[$('input[name^="specname"]')[k].value] = $('input[name^="specval"]')[k].value;
            });

            if(verify == false){
                return false;
            }else{
                data.spec_val = o;
            }
            var parent_index = parent.layer.getFrameIndex(window.name);

            var index = layer.msg('菜单发布中, 请稍等...', {icon: 16,shade: 0.01,time:0});
            $.ajax({
                url:"/seller/shop/addSpec",
                type:'post',
                data:data,
                dataType:'json',
                complete:function(){
                    layer.close(index);
                },
                success:function(res){
                    if(res.code == 200){
                        layer.msg('操作成功。。。', {icon: 1});
                        setTimeout(function(){
                            parent.layer.close(parent_index);
                        },2000);
                    }else{
                        layer.msg(res.message, {icon: 5});
                    }
                }
            });
        },
    };

    $(document).on('click','.cus-tr-move',function(){
        var type = $(this).data('type');
        if(type == 'down' || type == 'up'){
            obj.tdMove($(this),type);
        }else{
            if($(this).parent().data('id') == 0){
                $(this).parent().parent().remove();
            }else{
                var _this = $(this);
                layer.confirm('您确定要删除吗？', {
                    btn: ['删除','取消']
                }, function(){
                    _this.parent().parent().remove();
                });
            }
        }
    });
    $(document).on('keyup','.fr-blur',function(){
        var val = $(this).val();
        subject = val.replace(/[\-\_\,\.\!\|\~\`\(\)\#\@\%\-\+\=\/\'\$\%\^\&\*\{\}\:\;\"\L\<\>\?\\]/g, '');
        $(this).val(subject);
    });
</script>
</body>
</html>