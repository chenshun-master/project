<!DOCTYPE html>
<html lang="en">
<head>
    <!--  <meta content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width" name="viewport" />-->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,height=device-height, initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta name="viewport" content="target-densitydpi=device-dpi, width=750px, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta content="telephone=no" name="format-detection" />
    <link rel="stylesheet" type="text/css" href="/static/css/reg.css" />
    <title>Title</title>
    <style>
        .code-hui{
            color: #cccccc !important;
        }
    </style>
    <script src="/static/js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="/static/js/rem.js" type="text/javascript" charset="utf-8"></script>
</head>
<body style="background: #ffffff;">
    <div class="con">
        <div class="wx-top">
            <div class="wx-reg">
                <h3 style="font-size:0.38rem;width: 95%;height: 127px;line-height: 127px;text-align: center;color: #1f1f1f">绑定手机号</h3>
                <p style="margin-top: 40px;"><input id="mobile" type="text"  placeholder="请输入你的手机号" maxlength="11" onkeyup = "value=value.replace(/[^\d]/g,'')" /><button id="code-btn" onclick="objClass.sendSms()">获取验证码</button></p>
                <p style="margin-top: 40px;"><input id="sms_code" type="text" placeholder="请输入你收到的验证码" maxlength="6" onkeyup = "value=value.replace(/[^\d]/g,'')""></p>
                <input type="hidden" value="{$id}" id="fr-id">
                <button id="btn" style="margin-top: 40px;" onclick="objClass.submit()">完成绑定</button>
            </div>
        </div>
    </div>
</body>
<script src="/static/js/verification-code.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
    var codeObj = new VerificationCode('code-btn','获取验证码','code-hui');
    codeObj.run();

    var  objClass = {
        loading:false,
        sendSmsCode:false,
        checkMobile:function(mobile){
            var reg_phone = /^[1][3,4,5,7,8][0-9]{9}$/;
            return reg_phone.test(mobile);
        },
        submit:function(){
            var mobile = $('#mobile').val();
            var sms_code = $('#sms_code').val();
            var id = $('#fr-id').val();

            if(!this.checkMobile(mobile)){
                alert('手机号格式不正确！');
                layer.open({content: '手机号格式不正确！',skin: 'msg',time: 2});
                return false;
            }

            if(sms_code == ''){
                alert('请填写验证码！');
                return false;
            }
            if(!this.loading){
                $.ajax({
                    url:"/weixin/index/bindingMobileHandle",
                    type:'post',
                    data:{mobile:mobile,sms_code:sms_code,id:id},
                    dataType:'json',
                    beforeSend:function(){
                        objClass.loading = true;
                    },
                    complete:function(){
                        objClass.loading = false;
                    },
                    success:function(res){
                        if(res.code == 200){
                            window.location.href = '/weixin/user/main';
                            return false;
                        }else if(res.code == 301){
                            alert('请求参数错误');
                            return false;
                        }else if(res.code == 302){
                            alert('验证码错误');
                            return false;
                        }else if(res.code == 303){
                            alert('验证码已过期');
                            return false;
                        }else {
                            alert('验证码错误');
                            return false;
                        }
                    }
                });
            }
        },
        sendSms:function(){
            var mobile = $('#mobile').val();
            if(!this.checkMobile(mobile)){
                alert('手机号格式不正确');
                return false;
            }
            if(!this.sendSmsCode){
                var id = $('#fr-id').val();
                $.ajax({
                    url:"/weixin/index/sendOtherLoginSmsCode",
                    type:'post',
                    data:{mobile:mobile,sms_code: sms_code,id:id},
                    dataType:'json',
                    beforeSend:function(){
                        objClass.sendSmsCode = true;
                    },
                    complete:function(){
                        objClass.sendSmsCode = false;
                    },
                    success:function(res){
                        if(res.code == 200){
                            alert('发送成功');
                            codeObj.sendSmsCode();
                            return false;
                        }else if(res.code == 301){
                            alert('请求参数错误');
                            return false;
                        }else if(res.code == 302){
                            alert('该用户未被使用');
                            return false;
                        }else{
                            alert('发送失败');
                            return false;
                        }
                    }
                });
            }
        }
    };


    $(function(){
        $('.wx-reg input').on('.wx-reg input ',function(){
            if(($.trim($('#mobile').val())!=="") && ($.trim($('#sms_code').val())!=="")){
                $('#btn').css({'background':'#0fd6dd'});
            }else{
                $('#btn').css({'background':'#EBEBEB'});
            }
        });
    });

</script>
</html>