{extend name="layout/layout" /}

{block name="cssOrcrsipt"}
<link rel="stylesheet" href="/static/weixin/css/answer-details.css">
<link rel="stylesheet" href="/static/plugin/mescroll/mescroll.min.css">
{/block}

{block name="main"}
<div class="wl-top">
    <i class="iconfont icon-back_light" onclick="redream.toReferer()"></i>
    我的问答
</div>
<div id="container" class="mescroll">
    <div class="wl-answer-details">
        <div class="wl-title">
            {$info['title']}
        </div>
        <div class="wl-huida"><span class="wl-mehuida"><i class="iconfont icon-combinedshapecopy2"></i>我要回答</span>{$info['answer_num']}个回答 <i class="iconfont icon-back_left-copy"></i></div>
    </div>
    <div class="wl-user-name">
        <div class="wl-answers-top">
            <img src="{$info['portrait']}" alt="" onerror="this.src ='/static/image/user/tou.png'">
            <div class="wl-answers-name">
                <dt>{$info['nickname']}</dt>
            </div>
            <span class="wl-read">阅读 {$info['visit']}</span>
        </div>
        <div class="wl-conter">
            {$info['answer_content']}
        </div>
        <div class="wl-establish">创建于 {$info['answer_time']|date='Y-m-d H:i'}</div>
    </div>
    <div class="reply-comments">
        <div class="wl-reply-top">
            评论 <span class="comment-num">0</span>
        </div>
        <div id="container-list"></div>
    </div>

</div>
<div class="marsk-container">
    <div class="tkyy_con">
        <textarea id="wl-pincontent"></textarea><span class=" iconfont icon-fabu" onclick="myObj.publishComment()"></span>
    </div>
</div>
<ul class="wl-reply-footer">
    <li class="wl-write-comment"><i class="iconfont icon-combinedshapecopy2 wl-write"></i> 写评论...</li>
    <li><i class="iconfont icon-pinglun1 wl-comment-icon"></i><span class="wl-reply-num"><span class="comment-num">0</span></span></li>
    <li><i class="iconfont icon-dianzan2 wl-comment-icon"></i></li>
    <li><i class="iconfont icon-web__bitebiyoujiantou wl-comment-icon"></i></li>
</ul>
{/block}

{block name="script"}
<script src="/static/js/functions.js"></script>
<script src="/static/plugin/layui/layui.all.js"></script>
<script src="/static/plugin/mescroll/mescroll.min.js" charset="utf-8"></script>
<script id="templateList" type="text/html">
    {{#  layui.each(d, function(index, item){ }}
    <div class="wl-pinglun" data-id="{{ item.id}}">
        <div style="float: left">
            <img src="{{item.portrait}}" alt="" width="30" height="30" class="cus-touser-main " data-user_id="{{item.user_id}}" onerror="this.src='/static/image/user/tou.png'">
        </div>
        <div class="wl-ping-xiang">
            <div>
                <div class="wl-name cus-touser-main" data-user_id="{{item.user_id}}">{{item.nickname}}</div>
                {{#  if(item.islike == 0){ }}
                <div class=" wl-dianzan cus-comment-fabulous" style="font-size: 18px" data-id="{{item.id}}" data-click="{{item.islike}}" >
                    <span class="iconfont icon-dianzan wl-fabulous-icon" style="font-size: 18px;"></span>
                    <span class="wl-dian-one" style="font-size: 13px">{{item.like_count}}</span>
                </div>
                {{#  } }}
                {{#  if(item.islike == 1){ }}
                <div class=" wl-dianzan cus-comment-fabulous"  data-id="{{item.id}}" data-click="{{item.islike}}" >
                    <span class="iconfont icon-dianzan1" style="font-size: 18px;color: #7DB0E8; "></span>
                    <span style="font-size: 13px">{{item.like_count}}</span>
                </div>
                {{#  } }}
            </div>
            <div style="clear:both"></div>
            <div class="wl-ping-neirong">{{item.content}}</div>
            <div class="wl-pji">{{item.created_time}}</div>
        </div>
        <div style="clear:both"></div>
    </div>
    {{#  }); }}
</script>
<script>
    const answer_id = {$info['answer_id']};
    const inquiry_id = {$info['inquiry_id']};
    $(".wl-write-comment").click(function (event) {
        event.stopPropagation(); //停止事件冒泡
        $(".marsk-container").toggle();
        $('#wl-pincontent').focus();
    });

    //点击空白处隐藏弹出层
    $(".marsk-container").click(function (event) {
        var _con = $('.tkyy_con'); // 设置目标区域
        if (!_con.is(event.target) && _con.has(event.target).length == 0) {
            $('.marsk-container').hide(); //淡出消失
        }
    });
    $('textarea').keydown( function(e) {
        var key = window.event?e.keyCode:e.which;
        if(key.toString() == "13"){
            return false;
        }
    }).on('input', function () {
        this.style.height = (this.scrollHeight) + 'px';
    });

    const mescroll = new MeScroll("container", {
        down: {auto: true},
        up: {
            clearEmptyId: "container-list",
            page: {num: 0, size: 10},
            htmlNodata: '<p class="upwarp-nodata">-- 已加载全部 --</p>',
            isBounce: false,
            noMoreSize: 5,
            empty: {tip: "亲,暂时还没相关评论~"},
            callback: function (page) {
                $.ajax({
                    url: "/weixin/api/getCommentList",
                    type: 'get',
                    data: {obj_id:answer_id,page: page.num, page_size: page.size,type:4},
                    dataType: 'json',
                    success: function (res) {
                        mescroll.endSuccess(res.data.rows.length);
                        if(res.data.total){
                            $('.comment-num').text(res.data.total);
                        }
                        layui.laytpl(templateList.innerHTML).render(res.data.rows, function (html) {
                            $('#container-list').append(html);
                        });
                    },
                    error: function () {
                        mescroll.endErr();
                    }
                });
            },
        }
    });
    var  myObj = {
        publishCommentConf: {
            loading: false,
        },
        publishComment: function () {
            var content = $('#wl-pincontent').val();
            $.ajax({
                url: "/weixin/api/createComment",
                type: 'post',
                data: {type:4,obj_id: answer_id,content: content},
                dataType: 'json',
                beforeSend: function () {
                    myObj.publishCommentConf.loading = true;
                },
                success: function (res) {
                    myObj.publishCommentConf.loading = false;
                    if (res.code == 200) {
                        $('.marsk-container').css('display','none');
                        redream.showTip('发布成功');
                        $('#wl-pincontent').val('');
                        mescroll.resetUpScroll();
                    } else if (res.code == 401) {
                        redream.showTip('请先进行登录');
                        LoginBox.showBox();
                    } else {
                        redream.showTip('评论失败');
                    }
                }
            });
        },
        clickCommentFabulousLading:false,
        clickCommentFabulous:function (obj, flag) {
            var id = obj.data('id');
            console.log(id);
            var type = obj.data('click') == 1 ? 2 : 1;
            if(type == 2){
                return false;
            }else if(!myObj.clickCommentFabulousLading){
                $.ajax({
                    url: "/weixin/user/giveFabulous",
                    type: 'post',
                    data: {obj_id: id, type: type,flag:2},
                    dataType: 'json',
                    beforeSend: function () {
                        myObj.clickCommentFabulousLading = true;
                    },
                    complete: function () {
                        myObj.clickCommentFabulousLading = false;
                    },
                    success: function (res) {
                        if (res.code == 200) {
                            if (flag == 1) {
                                var num = parseInt(obj.find('.wl-dian-one').text());
                                if (type == 1) {
                                    obj.data('click', 1);
                                    obj.find('.wl-dian-one').text(num + 1);
                                    obj.find('.wl-fabulous-icon').removeClass('icon-dianzan').addClass('cus-blue').addClass('icon-dianzan1');
                                } else {
                                    obj.data('click', 0);
                                    obj.find('.wl-dian-one').text(num - 1);
                                }
                            }
                        }else if(res.code == 401){
                            LoginBox.showBox().showTip('请先进行登录操作');
                        }else if(res.code == 403){
                            redream.showTip('您还没有该权限');
                        }
                    }
                });
            }
        },
    }

    $(document).on('click', '.cus-comment-fabulous', function () {
        myObj.clickCommentFabulous($(this), 1);
    });
</script>
{/block}