{extend name="layout/layout" /}

{block name="cssOrcrsipt"}
<link rel="stylesheet" href="/static/weixin/shop/css/havegood_details.css">
<link rel="stylesheet" href="/static/css/swiper.min.css">
<style>
    .cus-blue {
        color: #7DB0E8 !important;
    }
</style>
{/block}

{block name="main"}

<!--这里编写主体内容-->
<div style="width: 100%;min-height: 500px;padding-bottom: 100px;overflow-y:hidden">
    <header>
        <div class="wl-top">
            <i class="iconfont icon-back_light wl-fahui " onclick="redream.toReferer()"></i>
            <i class="iconfont icon-share_light wl-fenxiang"></i>
        </div>
    </header>
    <main>
        <div class="swiper-container img-gao">
            <div class="swiper-wrapper ">
                {foreach($imgs as $src)}
                <div class="swiper-slide"><img src="{$src}" alt=""></div>
                {/foreach}
            </div>
            <div class="swiper-pagination"></div>
        </div>

        <div>
            <div class="wl-neirong">
                <div class="wl-title">{$info['title']}</div>
                <div class="wl-jiage">
                    <div class="wl-yuyue">
                        256人预约
                    </div>
                    <div class="wl-jiayo">
                        <sub style="font-size: 8px">￥</sub><span>4520</span>
                    </div>
                    <div style="clear: both"></div>
                </div>
            </div>

            <div class="wl-main href">
                <div>
                    <div class="wl-tou-img href"><img
                            src="http://172.16.100.85:81/head/20181212/1553215c10be7173bec5c10be7173bee.png" alt=""></div>
                    <div class="wl-tou-yonghu href">
                        <dl>张晴</dl>
                        <dt>2018年11月29日</dt>
                    </div>
                </div>
                <div class="wl-jiahy href">
                    <button onclick="myObj.showAddFriend()" id="cus-add-friend">加好友</button>
                </div>
                <div style="clear:both"></div>
            </div>
        </div>


        <div class="wl-content">
            <div class="wl-content-title">
                <p> 项目亮点</p>
                <hr/>
            </div>
            <div class="wl-xiangmu-lia">
                <?php echo $info['article_text'] ?>
            </div>
        </div>
        <div class="wl-tuijianshangpin">
            <div class="wl-tuijian-title">
                其它推荐商品
            </div>
            <div id="recommended-List">

            </div>
        </div>
    </main>
    <footer>
        <div class="wl-footer">
            <div class="cus-pinglun">
                <ul>
                    <li class="iconfont icon-like "id="cus-click-fabulous"  data-type="1" ></li>
                    <li class="iconfont  icon-comment_light cus-ping"></li>
                    <li class="iconfont icon-favor_light" id="cus-click-favorite"></li>
                </ul>
            </div>
            <div class="wl-goumai">
                <button><i class="iconfont icon-gouwuche"></i>去购买</button>
            </div>
        </div>
        <div style="clear: both"></div>
    </footer>
    <div class="marsk-container">
        <div class="tkyy_con">
            <div>
                <div class="wl-tan-pinglun"><i id="cus-pinglun-num">0</i>条评论 <span class="iconfont icon-guanbi1 wl-quxiao"></span></div>
            </div>
            <div class="wl-foot-gundong">
                <div id="container-list">

                </div>
            </div>
        </div>
        <div class="cus-footer">
            <input type="text" placeholder="据说颜值高的人都爱评论" class="wl-foot-input">
        </div>
    </div>
    <div class="wl-zhez2">
        <div class="wl-zl2">
            <textarea name="wl-text" cols="30" rows="10" class="wl-text" id="cus-comment-pid" placeholder="有爱评论，说点好听的..."></textarea>
            <i class="wl-fabu iconfont icon-fabu" onclick="myObj.publishComment()"></i>
        </div>
    </div>
</div>
<div class="wl-zhezhao">
    <div class="wl-zhe1">
        <p class="wl-renzh">申请备注</p>
        <div class="wl-neie1">
            <p>你需要发送验证申请，等待对方通过</p>
            <textarea class="wl-neie2" style="resize: none" placeholder="添加申请备注(必填)..." id="fr-friend-remarks"></textarea>
            <button class="wl-btn" onclick="myObj.submitFriendApply()">发送</button>
        </div>
    </div>
</div>
<input type="hidden" id="fr-goodid" value="{$info['goods_id']}">
<input type="hidden" id="fr-good-goods-id" value="{$info['id']}">
<input type="hidden" id="fr-user-id" value="{$info['user_id']}">
{/block}

{block name="script"}
<script src="/static/js/swiper.min.js" type="text/javascript" charset="utf-8"></script>
<script src="/static/plugin/layui/layui.all.js"></script>
<script id="templateList" type="text/html">
    {{#  layui.each(d, function(index, item){ }}
    <div class="wl-pinglun">
        <div style="float: left">
            <img src="{{item.portrait}}" alt="" width="30" height="30" onerror="this.src='/static/image/user/tou.png'" data-user_id="{{item.user_id}}"  class="cus-touser-main">
        </div>
        <div class="wl-ping-xiang">
            <div>
                <div class="wl-name cus-touser-main" data-user_id="{{item.user_id}}">{{item.nickname}}</div>
                {{#  if(item.islike == 0){ }}
                <div class=" wl-dianzan cus-comment-fabulous" style="font-size: 18px"  data-id="{{item.id}}" data-click="{{item.islike}}">
                    <span class="iconfont icon-dianzan wl-fabulous-icon" style="font-size: 18px;"></span>
                    <span class="wl-dian-one" style="font-size: 13px">{{item.islike}}</span>
                </div>
                {{#  } }}
                {{#  if(item.islike == 1){ }}
                <div class=" wl-dianzan cus-comment-fabulous"  data-id="{{item.id}}" data-click="{{item.islike}}" >
                    <span class="iconfont icon-dianzan1" style="font-size: 18px;color: #7DB0E8 "></span>
                    <span style="font-size: 13px">{{item.like_count}}</span>
                </div>
                {{#  } }}
            </div>
            <div style="clear:both"></div>
            <div class="wl-ping-neirong">{{item.content}}</div>
            <div class="wl-pji">{{item.created_time}}</div>
        </div>
        <div style="clear:both">
        </div>
    </div>
    {{#  }); }}
</script>
<script id="recommendedList" type="text/html">
    {{#  layui.each(d, function(index, item){ }}
    <div class="wl-remen click-to-havegoodDetails" data-id="{{item.id}}">
        <div class="wl-remen-img">
            <img src="http://172.16.100.85:81/goodsimgs/20181213/c3ead4524152d705f2ff8b2a77fc89b2.png"
                 alt="图片丢失" ></div>
        <div class="wl-remen-right">
            <dl>{{item.title}}</dl>
            <dt>{{item.title}}</dt>
            <dd>
                <span class="wl-jiageyushou"><sub style="font-size: 8px">￥</sub><span>4784</span></span>
                <span class="wl-quchu">￥880.00</span>
                <span class="wl-jiage1"><span style="margin-right: 10px">已售123</span></span>
            </dd>
        </div>
    </div>
    {{#  }); }}
</script>
<script>
    var mySwiper = new Swiper('.swiper-container', {
        autoplay: true,//可选选项，自动滑动
        pagination: {
            el: '.swiper-pagination',
        }
    });
    $(".cus-ping").click(function (event) {
        event.stopPropagation(); //停止事件冒泡
        $(".marsk-container").show();
        $("body").addClass("body");
    });

    //点击空白处隐藏弹出层
    $(".marsk-container").click(function (event) {
        var _con = $('.tkyy_con'); // 设置目标区域
        if (!_con.is(event.target) && _con.has(event.target).length == 0) {
            $('.marsk-container').hide(); //淡出消失
            $("body").removeClass("body");
        }
    }).on('touchstart', function (event) {
        var _con = $('.tkyy_con'); // 设置目标区域
        if (!_con.is(event.target) && _con.has(event.target).length == 0) {
            // $('.marsk-container').hide(); //淡出消失
            $("body").removeClass("body");
        }
        event.stopPropagation(); //停止事件冒泡
    });


    $(".wl-quxiao").click(function () {
        $(".marsk-container").hide();
        // $("body").removeClass("body");
    })

    $('.wl-tan-pinglun').on('touchstart', function (event) {
        $('.wl-foot-gundong').css('overflowY', "auto");
    });

    $('.wl-tan-pinglun').on('click', function (event) {
        $('.wl-foot-gundong').css('overflowY', "auto");
    });
    $(".wl-foot-input").click(function (event) {
        event.stopPropagation(); //停止事件冒泡
        $(".wl-zhez2").toggle();
        $('.wl-text').focus();
    });
    $(document).on('input', 'textarea', function () {
        if (($.trim($('.wl-text').val()) !== "")) {
            $('.wl-fabu').css({'color': '#7DB0E8'});
        } else {
            $('.wl-fabu').css({'color': '#B7B7B9'});
        }
    });
    //点击空白处隐藏弹出层
    $(".wl-zhez2").click(function (event) {
        var _con = $('.wl-zl2'); // 设置目标区域
        if (!_con.is(event.target) && _con.has(event.target).length == 0) {
            $('.wl-zhez2').hide(); //淡出消失
        }
    });
</script>
<script>
    var myObj = {
        goods: {
            listData: {
                gid: $('#fr-good-goods-id').val(),
                loading: false,
                ini: false,
                page: 0,
                page_total: 1,
                page_size: 15,
            },
            loadList: function () {
                if (myObj.goods.listData.loading) {
                    return false;
                }
                myObj.goods.listData.page++;
                if (myObj.goods.listData.ini == true) {
                    if (myObj.goods.listData.page > myObj.goods.listData.page_total) {
                        return false;
                    }
                }
                $.ajax({
                    url: "/weixin/shopapi/getGoodGoodsComment",
                    type: 'post',
                    data: {gid: myObj.goods.listData.gid, page: myObj.goods.listData.page, page_size: myObj.goods.listData.page_size
                    },
                    dataType: 'json',
                    beforeSend: function () {
                        myObj.goods.listData.loading = true;
                    },
                    complete: function () {
                        myObj.goods.listData.loading = false;
                    },
                    success: function (res) {
                        if (res.code == 200) {
                            if (myObj.goods.listData.ini == false) {
                                myObj.goods.listData.ini = true;
                                myObj.goods.listData.page_total = res.data.page_total;
                                $('#container-list').html('');
                                if(res.data.page_total == 0){
                                    $('#container-list').html(' <div class="wl-no-shuju"> <dl class="iconfont icon-tianxierenzhengxinxi"></dl> <dt>暂无评论</dt></div>');
                                }
                            }
                            $("#cus-pinglun-num").html(res.data.total);
                            layui.laytpl(templateList.innerHTML).render(res.data.rows, function (html) {
                                $('#container-list').append(html);
                            });
                        }
                    }
                });
            }
        },
        recommended: {
            listData: {
                gid: $('#fr-good-goods-id').val(),
                loading: false,
                ini: false,
                page: 0,
                page_total: 1,
                page_size: 3,
            },
            loadList: function () {
                if (myObj.recommended.listData.loading) {
                    return false;
                }
                myObj.recommended.listData.page++;
                if (myObj.recommended.listData.ini == true) {
                    if (myObj.recommended.listData.page > myObj.recommended.listData.page_total) {
                        return false;
                    }
                }
                $.ajax({
                    url: "/weixin/shopapi/getGoodGoodsRelevant",
                    type: 'post',
                    data: {
                        gid: myObj.recommended.listData.gid,
                        page: myObj.recommended.listData.page,
                        page_size: myObj.recommended.listData.page_size
                    },
                    dataType: 'json',
                    beforeSend: function () {
                        myObj.recommended.listData.loading = true;
                    },
                    complete: function () {
                        myObj.recommended.listData.loading = false;
                    },
                    success: function (res) {
                        if (res.code == 200) {
                            if (myObj.recommended.listData.ini == false) {
                                myObj.recommended.listData.ini = true;
                                myObj.recommended.listData.page_total = res.data.page_total;
                                $('#recommended-List').html('');
                                if (res.data.page_total == 0){
                                    $('#recommended-List').html(' <div class="wl-no-shuju" style="margin-top: 40px"> <dl class="iconfont icon-tianxierenzhengxinxi" style="font-size: 30px"></dl> <dt style="margin: 0">暂无商品</dt></div>');
                                }
                            }
                            layui.laytpl(recommendedList.innerHTML).render(res.data.rows, function (html) {
                                $('#recommended-List').append(html);
                            });
                        }
                    }
                });
            }
        },
        giveLikeLoading:false,
        giveLike:function(o,type,flag){
            if(myObj.giveLikeLoading == false){
                $.ajax({
                    url: "/weixin/shopapi/giveFabulous",
                    type: 'post',
                    data: {
                        obj_id: $('#fr-good-goods-id').val(),
                        flag:3 ,
                        type: type
                    },
                    dataType: 'json',
                    beforeSend: function () {
                        myObj.giveLikeLoading = true;
                    },
                    complete: function () {
                        myObj.giveLikeLoading = false;
                    },
                    success: function (res) {
                        if(res.code == 200){
                            if(type == 1){
                                    $('#cus-click-fabulous').removeClass('icon-like').addClass("icon-likefill").addClass('cus-red');
                                    o.data('type',2);
                                }else{
                                    o.data('type',1);
                                    $('#cus-click-fabulous').removeClass('cus-red').removeClass('icon-likefill').addClass("icon-like");
                                }
                            //
                            //     if (flag == 2){
                            //         $(".wl-fabulous-icon").removeClass("icon-dianzan").addClass("icon-dianzan1").addClass("cus-blue");
                            //     }
                            // }
                        }else if(res.code == 401){

                            redream.showTip('请登录后操作...');
                        }
                    }
                });
            }
        },

        publishCommentConf:{
            loading:false,
        },
        publishComment:function(type,flag){
            var content = $('.wl-text').val();
            $('.wl-text').focus();
            $('.wl-text').val('');
            var pid = $('#cus-comment-pid').val();
            $.ajax({
                url: "/weixin/shopapi/createGoodGoodsComment",
                type: 'post',
                data: {
                    obj_id: $('#fr-good-goods-id').val(),
                    content:content
                },
                dataType: 'json',
                beforeSend: function () {
                    myObj.publishCommentConf.loading = true;
                },
                success: function (res) {
                    myObj.publishCommentConf.loading = false;
                    if (res.code == 200) {
                        $('.wl-zhez2').hide();
                        myObj.recommended.ini= false;
                        myObj.recommended.page= 0;
                        myObj.recommended.page_total= 0;
                        myObj.goods.loadList();
                        redream.showTip('发布成功');
                        $('.wl-text').val('');
                    }else if (res.code == 401){
                        redream.showTip('请先进行登录');
                        $('.wl-zhez2').hide();
                    }
                }
            });
        },
        isAdd:false,
        addFriendLoading:false,
        showAddFriend:function(){
            if(!this.isAdd){
                $(".wl-zhezhao").toggle();
            }else{
                redream.showTip('不能重复申请...');
            }
        },
        //好友申请
        submitFriendApply:function(){
            var remarks = $.trim($('#fr-friend-remarks').val());
            if(redream.isEmptyStr(remarks)){
                redream.showTip('申请备注不能为空...');
                return false;
            }else if(!this.addFriendLoading){
                $.ajax({
                    url: "/weixin/user/addFriend",
                    type: 'post',
                    data: {
                        friend_id: $('#fr-user-id').val(),
                        remarks:remarks
                    },
                    dataType: 'json',
                    beforeSend:function(){
                        myObj.addFriendLoading = true;
                    },
                    complete:function(){
                        myObj.addFriendLoading = false;
                    },
                    success: function (res) {
                        if (res.code == 200) {
                            myObj.isAdd = true;
                            redream.showTip('申请提交成功...');
                            $('#cus-add-friend').text('已申请');
                            $(".wl-zhezhao").toggle();
                            $(".wl-zhezhao").hide();
                        }else if (res.code == 401){
                            redream.showTip('请先进行登录');
                        }else if (res.code == 403){
                            redream.showTip('您还没有授权');
                        }else{
                            redream.showTip(res.msg);
                        }
                    }
                });
            }
        },
        //收藏
        myFavorite:{
            loading:false,
            submit:function(){
                if(myObj.myFavorite.loading){
                    return false;
                }
                $.ajax({
                    url: "/weixin/article/addFavorite",
                    type: 'post',
                    data: { obj_id: $('#fr-good-goods-id').val(),},
                    dataType: 'json',
                    beforeSend: function () {
                        myObj.myFavorite.loading = true;
                    },
                    success: function (res) {
                        myObj.myFavorite.loading = false;
                        if (res.code == 200) {
                            $('#cus-click-favorite').removeClass('icon-favor_light').addClass('icon-favor_fill_light').addClass('cus-favorite');
                            myObj.myFavorite.loading = true;
                            redream.showTip('收藏成功...');
                        }else if(res.code == 401){
                            redream.showTip('请登录后操作...');
                        }
                    }
                });
            }
        },
    };
    myObj.goods.loadList();
    myObj.recommended.loadList();

    $('#cus-click-fabulous').on('click',function(){
        var type = $(this).data('type');
        myObj.giveLike($(this),type);
    });
    $(document).on('click', '.cus-comment-fabulous', function () {
        var flag = $(this).data('flag');
        myObj.giveLike($(this),flag);
    });
    $(document).on('click', '.cus-touser-main', function () {
        window.location.href = '/weixin/article/userMain/id/' + $(this).data('user_id');
    });
    $('#cus-click-favorite').on('click', function () {
        myObj.myFavorite.submit();
    });
    $(".wl-zhezhao").click(function (event) {
        var _con = $('.wl-zhe1'); // 设置目标区域
        if (!_con.is(event.target) && _con.has(event.target).length == 0) {
            $('.wl-zhezhao').hide(); //淡出消失
        }
    });
</script>
{/block}